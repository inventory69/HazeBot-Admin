name: Build Android Test APK

on:
  push:
    branches: [ test ]  # Trigger only on test branch
  # Note: pull_request trigger removed to save GitHub Actions minutes
  # Test APK builds can be triggered manually via workflow_dispatch
  # Production APKs are still built automatically on push to main
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write  # Required for creating releases

jobs:
  build:
    name: Build Test APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.7'
          channel: 'stable'
      
      - name: Verify API_BASE_URL secret is set
        run: |
          if [ -z "${{ secrets.API_BASE_URL }}" ]; then
            echo "::error::Secret API_BASE_URL is not set!"
            echo "Please add API_BASE_URL to your repository secrets."
            echo "Go to: Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret"
            exit 1
          fi
      
      - name: Create .env file with configuration
        run: |
          echo "API_BASE_URL=${{ secrets.API_BASE_URL }}" > .env
          echo "IMAGE_PROXY_URL=${{ secrets.IMAGE_PROXY_URL }}" >> .env
          echo "GITHUB_REPO_URL=https://github.com/inventory69/HazeBot-Admin" >> .env
          echo "PROD_MODE=${{ secrets.PROD_MODE }}" >> .env
          echo "‚úÖ .env file created with configuration"
          echo "   üì¶ API_BASE_URL: ${{ secrets.API_BASE_URL }}"
          echo "   üñºÔ∏è  IMAGE_PROXY_URL: ${{ secrets.IMAGE_PROXY_URL }}"
          echo "   üîß PROD_MODE: ${{ secrets.PROD_MODE }}"
      
      - name: Create Firebase config
        run: |
          if [ -n "${{ secrets.GOOGLE_SERVICES_JSON }}" ]; then
            echo '${{ secrets.GOOGLE_SERVICES_JSON }}' > android/app/google-services.json
            echo "‚úÖ Firebase configuration created (Push notifications enabled)"
          else
            echo "‚ö†Ô∏è GOOGLE_SERVICES_JSON secret not set - Building without Firebase support"
            echo "   Push notifications will be disabled in this build"
            echo "   To enable: Add GOOGLE_SERVICES_JSON secret in repository settings"
          fi
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Generate version number
        run: |
          # Generate version: YYYY.MM.DD
          VERSION_NAME="$(date +'%Y.%m.%d')"
          # Use GitHub run number as build number
          BUILD_NUMBER="${{ github.run_number }}"
          
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
          echo "VERSION_TAG=v$VERSION_NAME-build.$BUILD_NUMBER" >> $GITHUB_ENV
          
          echo "üì¶ Generated version: $VERSION_NAME+$BUILD_NUMBER"
      
      - name: Update pubspec.yaml with version
        run: |
          # Update version in pubspec.yaml
          sed -i "s/^version: .*/version: ${{ env.VERSION_NAME }}+${{ env.BUILD_NUMBER }}/" pubspec.yaml
          
          echo "‚úÖ Updated pubspec.yaml:"
          grep "^version:" pubspec.yaml
      
      - name: Setup Android signing
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/upload-keystore.jks
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" > android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
          echo "storeFile=upload-keystore.jks" >> android/key.properties
          echo "‚úÖ Signing configuration created"
      
      - name: Build APK (Debug)
        if: github.ref != 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/')
        run: flutter build apk --debug
      
      - name: Build APK (Release)
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
        run: flutter build apk --release
      
      - name: Rename APK to indicate test version
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ] || [[ "${{ github.ref }}" == refs/tags/* ]]; then
            mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/hazebot-admin-test-release.apk
            echo "apk_path=build/app/outputs/flutter-apk/hazebot-admin-test-release.apk" >> $GITHUB_ENV
            echo "apk_name=hazebot-admin-test-release.apk" >> $GITHUB_ENV
          else
            mv build/app/outputs/flutter-apk/app-debug.apk build/app/outputs/flutter-apk/hazebot-admin-test-debug.apk
            echo "apk_path=build/app/outputs/flutter-apk/hazebot-admin-test-debug.apk" >> $GITHUB_ENV
            echo "apk_name=hazebot-admin-test-debug.apk" >> $GITHUB_ENV
          fi
      
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.apk_name }}
          path: ${{ env.apk_path }}
          retention-days: 30
      
      - name: Get commit info
        if: github.ref == 'refs/heads/main'
        run: |
          echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "COMMIT_DATE=$(git log -1 --format=%cd --date=iso-strict)" >> $GITHUB_ENV
          
          # Get full commit message preserving newlines
          {
            echo 'COMMIT_MSG<<EOF'
            git log -1 --pretty=%B
            echo 'EOF'
          } >> $GITHUB_ENV
      
      - name: Create Tag and Release
        if: github.ref == 'refs/heads/test'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION_TAG }}
          name: "üß™ Test Build ${{ env.BUILD_NUMBER }}"
          files: ${{ env.apk_path }}
          draft: false
          prerelease: true  # Mark as pre-release to distinguish from production
          generate_release_notes: false
          body: |
            # üß™ Test Build ${{ env.BUILD_NUMBER }}
            
            ## Build Information
            
            - **Version:** ${{ env.VERSION_NAME }}+${{ env.BUILD_NUMBER }}
            - **Build Date:** ${{ env.COMMIT_DATE }}
            - **Commit:** ${{ env.SHORT_SHA }}
            - **Environment:** ‚ö†Ô∏è **TEST**
            
            ---
            
            ## üìã Changes
            
            ${{ env.COMMIT_MSG }}
            
            ---
            
            ## üì¶ Download & Installation
            
            ### Download
            Download `hazebot-admin-test-release.apk` from the assets below.
            
            ### Installation Steps
            1. Download the APK from the assets section
            2. Enable "Install from unknown sources" in Android settings
            3. Open the downloaded APK file
            4. Follow the installation prompts
            5. Login with your test credentials
            
            ---
            
            ## ‚ö†Ô∏è Configuration
            
            - ‚ö†Ô∏è This is a **TEST BUILD**
            - ‚ö†Ô∏è Connected to **TEST API server**
            - ‚ö†Ô∏è For testing purposes only
            - ‚ö†Ô∏è May contain experimental features
            
            ---
            
            ## üöÄ Production Version
            
            For the stable production version, look for releases marked with üöÄ **Production**.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create Manual Tagged Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.apk_path }}
          draft: false
          prerelease: false
          body: |
            ## Test Build
            
            ‚ö†Ô∏è **This is a TEST build** configured with test API URL.
            
            ### What's included:
            - Configured for test environment
            - API configured for test server
            - Ready for testing on Android devices
            
            ### Installation:
            1. Download the APK
            2. Enable "Install from unknown sources" on your Android device
            3. Install the APK
            4. Login with provided credentials
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
